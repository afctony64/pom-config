id: opportunity_with_company_categories
name: Opportunity with Company Categories
type: data_card
file: opportunity_with_company_categories.yaml
description: >
  Sales opportunities with company categorical classifications for efficient pivot table analysis.
  Fetches ONLY Cat fields from all researchers for fast queries and small payloads.
  Use this for opportunity dashboards, pipeline analysis, and categorical pivots.
  For complete data, use opportunity_with_account instead.

# THIS IS AN OPTIMIZED DATA MODEL FOR PIVOT TABLES
# Fetches opportunity fields + company Cat fields (no LLM or research fields)
# 3-4x faster than opportunity_with_account due to smaller payload

# Tagging system
tags:
  - sales
  - pipeline
  - opportunities
  - categories
  - pivot-tables
  - efficient
  - cat-fields

# Core search configuration
search_type: graphql
executor: graphql

# üé® Frontend Display Control
display: true  # User-facing card for efficient opportunity dashboards

# Data model definition
collection: Company_opportunity

parameters:
  type: graphql
  collection: Company_opportunity

  # Relationship configuration
  relationship_traversal: true
  dynamic_templates: true

  # ‚ùå REMOVED: Explicit references list (conflicts with auto-discovery in collections section)
  # See collections[0].references.company for reference configuration with auto-discovery

  # Default settings
  limit: 10000  # Support large batch operations (categorical data has small payload)
  limit_default: 10000

# üéØ TAG-BASED FILTERING - Fetch ONLY Cat fields for efficient pivot tables
# No explicit fields - let the system resolve based on tags!
fields: {}

# Specify tags to include for researcher collections
field_tags:
  - Cat

# Collection compatibility
collections:
  - collection: Company_opportunity
    uses_field_set: standard  # Opportunity fields (stage, amount, probability)
    primary: true
    references:
      company:
        target_collection: Company_source
        field_set: standard  # Minimal Company_source fields (identity only)
        # ‚úÖ AUTO-DISCOVERY: System automatically discovers ALL nested references from Company_source schema
        # DataFactory auto-discovers: industry, customer, financial, product, competitor, 
        # journalist, leadership, partner, risk, social (10 researchers)
        # field_tags=[Cat] applied to ALL auto-discovered nested references (only Cat fields fetched)
        # No need to manually list nested_references - cleaner and more maintainable!
  - collection: Company_source
    uses_field_set: standard
    via_reference: company

# Query behavior
supports_relationships: true
supports_aggregation: true
supports_grouping: true
requires_query_text: false

# Performance settings
default_limit: 100  # Higher default for categorical data (smaller payload)
max_limit: 1000
timeout_seconds: 30

# üéØ FIELD DEFAULTS - Query model provides FIELD NAMES for view card inputs
# These are optimized for pivot tables with categorical dimensions
field_defaults:
  # Primary category and value (used by most charts: bar, line, pie)
  cat1: stage           # Primary category for grouping
  val1: amount          # Primary numeric value for aggregation

  # Secondary category and value (nested tables, heatmaps, scatter)
  cat2: company_customer_useCaseCat  # Secondary category (categorical from researcher)
  val2: probability     # Secondary numeric value

  # Visual encoding (scatter/bubble charts)
  size: amount          # Point size dimension for bubble charts

# Compatibility - what view cards work with this
# (View cards that need categorical and numeric fields)
compatible_view_types:
  - heatmap
  - pivot
  - chart
  - table
  - scatter
  - bar
  - line

# Business context
contexts:
  - sales_analysis
  - pipeline_management
  - opportunity_tracking
  - categorical_analysis

# User-facing metadata
user_documentation:
  short_description: "Sales opportunities with company categorical classifications (fast)"
  use_cases:
    - "Opportunity pivot tables by company categories"
    - "Pipeline dashboards with categorical dimensions"
    - "Win rate analysis by company segment"
    - "Opportunity distribution by industry, use case, etc."
  example_analyses:
    - "Pivot: company_customer_useCaseCat √ó stage (opportunities by use case and stage)"
    - "Pivot: company_industry_industryCat √ó stage (opportunities by industry and stage)"
    - "Chart: win rate by company_customer_segmentCat (customer segment analysis)"
  performance_notes: |
    OPTIMIZED FOR PIVOT TABLES:
    - Only Cat fields from researchers (no LLM or research fields)
    - 3-4x faster than opportunity_with_account
    - Higher default limit (100 vs 10) due to smaller payload
    - Perfect for dashboards and real-time analysis

  comparison:
    opportunity_with_account: "All fields (complete) - comprehensive but slower"
    opportunity_with_company_categories: "Cat fields only - fast and efficient for pivot tables (THIS CARD)"

  tag_strategy: |
    CATEGORICAL FIELD SELECTION:

    Company_opportunity: uses_field_set='standard' (stage, amount, probability, closeDate)
    Company_source: uses_field_set='standard' (minimal identity fields)
    Researcher collections: field_tags=[Cat]

    This fetches ONLY:
    - Company_opportunity: Standard fields (stage, amount, probability)
    - Company_source: Standard fields (accountName, accountType, state)
    - Researchers: Cat fields ONLY (useCaseCat, industryCat, segmentCat, etc.)

    EXCLUDED:
    - LLM fields (detailed analysis - use opportunity_with_account instead)
    - Research fields (raw data - use opportunity_with_account instead)

  usage_examples:
    - name: "Pivot table: Opportunities by industry and stage"
      query: "data_card_id: opportunity_with_company_categories, limit: 100"
      notes: "Fast categorical pivot table"

    - name: "Dashboard: Pipeline by customer segment"
      query: "data_card_id: opportunity_with_company_categories, limit: 100"
      pivot: "rows: company_customer_segmentCat, cols: stage, values: amount"

    - name: "Win rate by use case"
      query: "data_card_id: opportunity_with_company_categories"
      analysis: "Group by company_customer_useCaseCat, calculate won/total"

