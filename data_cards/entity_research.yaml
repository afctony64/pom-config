id: entity_research
collection: Domain
name: Research All
type: data_card
file: entity_research.yaml
description: >
  Fetch Domain records with ALL researcher fields (Cat, LLM, and research) from all Research_* collections.
  Uses tag-based filtering to get comprehensive research data.
  Part of the Entity Research Suite - use specialized cards for specific needs:
  - entity_research: ALL fields (comprehensive, slower)
  - entity_research_categories: Cat fields only (pivot tables, fast)
  - entity_research_analysis: LLM fields only (detailed insights)

# Tagging system
tags:
  - research
  - cat-fields
  - llm-fields
  - research-fields
  - entity-intelligence
  - comprehensive
  - entity-model

target_scope: entity_intelligence
executor: fetch  # âœ… Use native methods (native methods)

# ðŸŽ¨ Frontend Display Control
display: true  # User-facing card for comprehensive entity research
relationship_support: true

personas:
  - "*"

parameters:
  type: fetch  # Legacy parameter format (for compatibility)

  # Root collection - Domain IS the entity in entity model
  collection: Domain

  # âœ… FIX: Use direct parallel queries (no traversal overhead)
  # Remove traversal - query each Research_* collection directly
  relationship_traversal: true
  dynamic_templates: true

  # FIX #433: Traversal configuration to prevent circular references
  # Research_* collections have domainBeacon â†’ Domain, which could create loops
  traversal:
    max_depth: 1                    # Domain â†’ Research_* â†’ STOP (no deeper)
    max_complexity: 150             # Allow more complexity for 10+ collections
    use_default_policies: false     # âœ… CRITICAL: Disable pom-core's hardcoded competitor skip!
    policies:
      # Only block back-references that would create infinite loops
      # DO NOT block forward references like Domain.competitor - we need that data!
      domainBeacon: skip            # Skip Research_*.domainBeacon â†’ Domain (prevents loops)
      spawnedFromRef: skip          # Skip Domain.spawnedFromRef â†’ Domain (prevents loops)

  # Fetch one or more entities
  limit: 10000
  limit_default: 10000

  # âœ… PRIORITY: Data card level field_set (overrides collection-level)
  # This applies to ALL collections unless overridden at collection level
  field_set: [standard, extended, array]

# ðŸŽ¯ TAG-BASED FILTERING - Fetch fields by tags (Cat, LLM, research)
# No explicit fields - let the system resolve based on tags!
fields: {}

# Specify tags to include for all researcher collections
field_tags:
  - Cat
  - LLM
  - research

# âœ… FIX: Explicit list of all collections - direct parallel queries
# No traversal, no auto-discovery - just 11 simple queries in parallel
# 
# WORKAROUND: Until pom-core Issue #370 is fixed (parameters.field_set priority),
# we need to explicitly set field_set on each collection.
# Once Issue #370 is fixed, collections will inherit from parameters.field_set.
#
# Priority order (when Issue #370 fixed):
#   1. parameters.field_set (PRIORITY) - applies to all collections
#   2. collections[].field_set (DEFAULT/FALLBACK) - used only if parameters not set
#   3. Default "standard" - final fallback
collections:
  - collection: Domain
    required: true
    field_set: [standard, extended, array]  # WORKAROUND: Explicit until Issue #370 fixed

  # Explicit list of all Research_* collections - queried in parallel
  # WORKAROUND: Explicit field_set until pom-core Issue #370 implements priority order
  - collection: Research_industry
    field_set: [standard, extended, array]
  - collection: Research_financial
    field_set: [standard, extended, array]
  - collection: Research_product
    field_set: [standard, extended, array]
  - collection: Research_customer
    field_set: [standard, extended, array]
  - collection: Research_leadership
    field_set: [standard, extended, array]
  - collection: Research_competitor
    field_set: [standard, extended, array]
  - collection: Research_partner
    field_set: [standard, extended, array]
  - collection: Research_risk
    field_set: [standard, extended, array]
  - collection: Research_journalist
    field_set: [standard, extended, array]
  - collection: Research_social
    field_set: [standard, extended, array]

# Chat intelligence integration
chat_integration:
  best_for:
    - "Comprehensive entity research with all fields"
    - "Reports requiring Cat, LLM, and research data"
    - "Deep dive analysis with full context"
    - "Complete entity dossiers"

  usage_patterns:
    - "Returns all Cat, LLM, and research tagged fields"
    - "Excludes system fields automatically"
    - "Perfect for detailed dossiers and research reports"
    - "Works for any entity type (Company, Destination, Character, etc.)"

  parameter_examples:
    - name: "Full entity research"
      params: {limit: 100}
    - name: "Single entity full context"
      params: {where: {domain: "example.com"}}

# Response structure
response_structure:
  root_object: Domain
  includes_relationships: true
  relationship_style: reverse_traversal
  field_focus: comprehensive_research
  expected_collections:
    - Domain
    - Research_industry
    - Research_financial
    - Research_product
    - Research_leadership
    - Research_customer
    - Research_competitor
    - Research_partner
    - Research_risk
    - Research_journalist
    - Research_social

# Documentation
documentation:
  overview: |
    This data card fetches comprehensive research data using tag-based filtering.
    It returns all Cat fields (classifications), LLM fields (analysis), and research
    fields (detailed facts) for complete entity intelligence.

    Works with Entity Model: Domain + Research_* collections (not Company_source).

  tag_strategy: |
    HYBRID FIELD SELECTION:

    Domain: field_set=[standard, extended, array] (url, domain, description, metadata + standard fields)
    Research collections: field_set=[standard, extended, array] + field_tags=[Cat, LLM, research]

    This fetches:
    - Domain: Standard + Extended fields (entity identity, URL, metadata)
    - Researchers: Standard fields (Cat, LLM, research tags with standard set)
    - Researchers: Extended fields (citations, additional context)
    - Researchers: Array fields (parallel arrays like keyCompetitors, competitorPositioning, etc.)

  usage_examples:
    - name: "Fetch entities with full research data"
      query: "data_card_id: entity_research, limit: 100"
      notes: "Gets all Cat, LLM, and research fields"

    - name: "Fetch single entity by domain"
      query: "data_card_id: entity_research, where: {domain: 'example.com'}"

    - name: "Entity dossier (full context)"
      query: "data_card_id: entity_research, where: {domain: 'example.com'}"
      output: "Domain + all Cat/LLM/research fields from 10 researchers"

  entity_research_suite: |
    COMPLETE SUITE OF 3 DATA CARDS FOR DIFFERENT USE CASES:

    1. entity_research (this card)
       - Tags: [Cat, LLM, research]
       - Use: Comprehensive analysis, complete dossiers
       - Performance: Slower (large payload) - ~15-27s for 100 records
       - Limit: 10000 default (supports large batch operations)

    2. entity_research_categories
       - Tags: [Cat]
       - Use: Pivot tables, cross-tabs, dashboards
       - Performance: Fast (small payload) - ~2-7s for 100 records
       - Limit: 10000 default

    3. entity_research_analysis
       - Tags: [LLM]
       - Use: Detailed insights, qualitative reports
       - Performance: Medium (LLM fields only) - ~9-15s for 100 records
       - Limit: 10000 default (supports large batch operations)

    RECOMMENDATION: Start with entity_research_categories for exploration,
    then use entity_research_analysis for detailed analysis of specific entities.
