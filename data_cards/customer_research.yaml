id: customer_research
collection: Research_customer  # ✅ ROOT = Researcher, not Domain
name: Customer Research
type: data_card
file: customer_research.yaml
description: >
  Customer intelligence with customer segment analysis and key customer traversal.
  Starts from Research_customer, traverses to customer Domain records via keyCustomerRefs,
  then traverses to each customer's research data (industry, financial, product, etc.).

tags:
  - research
  - customer
  - entity-intelligence
  - deep-traversal

target_scope: entity_intelligence
executor: fetch
display: true
relationship_support: true

personas:
  - "*"

parameters:
  type: fetch
  collection: Research_customer
  relationship_traversal: true   # ✅ Allow explicit reference traversal
  dynamic_templates: false       # ✅ DISABLE auto-discovery (we define all paths)
  limit: 10000
  limit_default: 10000
  field_set: [standard, extended, array]
  preserve_reference_arrays: true  # Keep keyCustomerRefs as array for iterate_over

  # Traversal depth for keyCustomerRefs → Domain → Research_*
  traversal:
    max_depth: 2                   # Research_customer → Domain (1) → properties resolved (2)
    max_complexity: 200
    policies:
      domainBeacon: skip           # Skip circular Domain refs from researchers

fields: {}

field_tags:
  - Cat
  - LLM
  - research

collections:
  # ==========================================================================
  # ROOT: Source entity's customer research
  # ==========================================================================
  - collection: Research_customer
    required: true
    primary: true
    field_set: [standard, extended, array]
    references:
      domainBeacon:
        target_collection: Domain
        field_set: [standard]
        # ✅ FRONTEND REQUIREMENT: Only show entities ready for review
        filters:
          - field: ready_for_review
            operator: equal
            value: true
      keyCustomerRefs:
        target_collection: Domain
        field_set: [standard]
        # This traversal gives us customer Domain records with their references
        references:
          # From customer Domain → their researchers
          industry:
            target_collection: Research_industry
            field_set: [standard]
          financial:
            target_collection: Research_financial
            field_set: [standard]
          product:
            target_collection: Research_product
            field_set: [standard]
          leadership:
            target_collection: Research_leadership
            field_set: [standard]
          customer:
            target_collection: Research_customer
            field_set: [standard]
          competitor:
            target_collection: Research_competitor
            field_set: [standard]
          partner:
            target_collection: Research_partner
            field_set: [standard]
          journalist:
            target_collection: Research_journalist
            field_set: [standard]
          social:
            target_collection: Research_social
            field_set: [standard]
          risk:
            target_collection: Research_risk
            field_set: [standard]

  # ==========================================================================
  # Source entity's Domain
  # ==========================================================================
  - collection: Domain
    field_set: [standard]
    via_reference: domainBeacon

  # ==========================================================================
  # Customer Domains (with full research data)
  # ==========================================================================
  - collection: Domain
    alias: CustomerDomain
    field_set: [standard]
    via_reference: keyCustomerRefs

chat_integration:
  best_for:
    - "Customer segment intelligence"
    - "Key customer analysis and profiles"
    - "Use case and value proposition research"

  usage_patterns:
    - "Starts from Research_customer (source entity)"
    - "Traverses to customer Domain[] via keyCustomerRefs"
    - "From each customer Domain → their full research data"
    - "Returns complete dossier for source AND each customer"

  parameter_examples:
    - name: "Full customer intelligence"
      params: {where: {domain: "example.com"}}

response_structure:
  root_object: Research_customer
  includes_relationships: true
  relationship_style: explicit_only
  expected_collections:
    - Research_customer        # Source entity's customer analysis
    - Domain                   # Source entity's Domain
    - CustomerDomain           # Each customer's Domain
    - Research_industry        # Each customer's industry research
    - Research_financial       # Each customer's financial research
    - Research_product         # Each customer's product research
    - Research_leadership      # Each customer's leadership research
    - Research_customer        # Each customer's customer research
    - Research_risk            # Each customer's risk research
    - Research_partner         # Each customer's partner research
    - Research_journalist      # Each customer's journalist research
    - Research_social          # Each customer's social research

documentation:
  overview: |
    Customer intelligence data card.
    
    TRAVERSAL PATHS:
    1. Research_customer → Domain (source entity info via domainBeacon)
    2. Research_customer → Domain[] (via keyCustomerRefs = customer entities)
    3. CustomerDomain → Research_industry (customer's industry intel)
    4. CustomerDomain → Research_financial (customer's financial intel)
    5. CustomerDomain → Research_product (customer's product intel)
    6. CustomerDomain → Research_leadership (customer's leadership intel)
    7. CustomerDomain → Research_customer (customer's customer intel)
    8. CustomerDomain → Research_competitor (customer's competitor intel)
    9. CustomerDomain → Research_risk (customer's risk intel)
    
    RESULT: For each customer in keyCustomers, you get their FULL research dossier:
    - Domain metadata (title, description, url)
    - Industry classification and analysis
    - Financial profile (revenue, funding, employees)
    - Product intelligence (categories, pricing, features)
    - Leadership analysis
    - Customer intelligence
    - Their own competitive landscape!
    - Risk assessment
