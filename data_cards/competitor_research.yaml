id: competitor_research
collection: Research_competitor  # ✅ ROOT = Researcher, not Domain
name: Competitor Research
type: data_card
file: competitor_research.yaml
description: >
  Full competitive intelligence with deep competitor traversal.
  Starts from Research_competitor, traverses to competitor Domain records via keyCompetitorRefs,
  then traverses to each competitor's FULL research data (industry, financial, product, etc.).

tags:
  - research
  - competitor
  - entity-intelligence
  - deep-traversal

target_scope: entity_intelligence
executor: fetch
display: true
relationship_support: true

personas:
  - "*"

parameters:
  type: fetch
  collection: Research_competitor
  relationship_traversal: true   # ✅ Allow explicit reference traversal
  dynamic_templates: false       # ✅ DISABLE auto-discovery (we define all paths)
  limit: 10000
  limit_default: 10000
  field_set: [standard, extended, array]
  preserve_reference_arrays: true  # Keep keyCompetitorRefs as array for iterate_over

  # Traversal depth for keyCompetitorRefs → Domain → Research_*
  traversal:
    max_depth: 2                   # Research_competitor → Domain (1) → properties resolved (2)
    max_complexity: 200
    policies:
      domainBeacon: skip           # Skip circular Domain refs from researchers

fields: {}

field_tags:
  - Cat
  - LLM
  - research

collections:
  # ==========================================================================
  # ROOT: Source entity's competitor research
  # ==========================================================================
  - collection: Research_competitor
    required: true
    primary: true
    field_set: [standard, extended, array]
    references:
      domainBeacon:
        target_collection: Domain
        field_set: [standard]
        # ✅ FRONTEND REQUIREMENT: Only show entities ready for review
        filters:
          - field: ready_for_review
            operator: equal
            value: true
      keyCompetitorRefs:
        target_collection: Domain
        field_set: [standard]
        # This traversal gives us competitor Domain records with their references
        references:
          # From competitor Domain → their researchers
          industry:
            target_collection: Research_industry
            field_set: [standard]
          financial:
            target_collection: Research_financial
            field_set: [standard]
          product:
            target_collection: Research_product
            field_set: [standard]
          leadership:
            target_collection: Research_leadership
            field_set: [standard]
          customer:
            target_collection: Research_customer
            field_set: [standard]
          competitor:
            target_collection: Research_competitor
            field_set: [standard]
          partner:
            target_collection: Research_partner
            field_set: [standard]
          journalist:
            target_collection: Research_journalist
            field_set: [standard]
          social:
            target_collection: Research_social
            field_set: [standard]
          risk:
            target_collection: Research_risk
            field_set: [standard]

  # ==========================================================================
  # Source entity's Domain
  # ==========================================================================
  - collection: Domain
    field_set: [standard]
    via_reference: domainBeacon

  # ==========================================================================
  # Competitor Domains (with full research data)
  # ==========================================================================
  - collection: Domain
    alias: CompetitorDomain
    field_set: [standard]
    via_reference: keyCompetitorRefs

chat_integration:
  best_for:
    - "Full competitive intelligence with competitor dossiers"
    - "Deep competitor analysis across all researchers"
    - "Comparative intelligence reports"

  usage_patterns:
    - "Starts from Research_competitor (source entity)"
    - "Traverses to competitor Domain[] via keyCompetitorRefs"
    - "From each competitor Domain → their full research data"
    - "Returns complete dossier for source AND each competitor"

  parameter_examples:
    - name: "Full competitor intelligence"
      params: {where: {domain: "example.com"}}

response_structure:
  root_object: Research_competitor
  includes_relationships: true
  relationship_style: explicit_only
  expected_collections:
    - Research_competitor      # Source entity's competitor analysis
    - Domain                   # Source entity's Domain
    - CompetitorDomain         # Each competitor's Domain
    - Research_industry        # Each competitor's industry research
    - Research_financial       # Each competitor's financial research
    - Research_product         # Each competitor's product research
    - Research_leadership      # Each competitor's leadership research
    - Research_customer        # Each competitor's customer research
    - Research_risk            # Each competitor's risk research
    - Research_partner         # Each competitor's partner research
    - Research_journalist      # Each competitor's journalist research
    - Research_social          # Each competitor's social research

documentation:
  overview: |
    Full competitive intelligence data card with deep traversal.

    TRAVERSAL PATHS:
    1. Research_competitor → Domain (source entity info)
    2. Research_competitor → Domain[] (via keyCompetitorRefs = competitor entities)
    3. CompetitorDomain → Research_industry (competitor's industry intel)
    4. CompetitorDomain → Research_financial (competitor's financial intel)
    5. CompetitorDomain → Research_product (competitor's product intel)
    6. CompetitorDomain → Research_leadership (competitor's leadership intel)
    7. CompetitorDomain → Research_customer (competitor's customer intel)
    8. CompetitorDomain → Research_competitor (competitor's own competitor intel!)
    9. CompetitorDomain → Research_risk (competitor's risk intel)

    RESULT: For each competitor in keyCompetitors, you get their FULL research dossier:
    - Domain metadata (title, description, url)
    - Industry classification and analysis
    - Financial profile (revenue, funding, employees)
    - Product intelligence (categories, pricing, features)
    - Leadership analysis
    - Customer intelligence
    - Their own competitive landscape!
    - Risk assessment
