id: domain
type: researcher_ai
researcher_type: domain
collection_schema_id: Domain
name: Domain Identity

update_mode: true
confidence_based_update: true
execution_order: 100

output_fields:
  - entityName
  - country
  - foundedYear
  - headquarters
  - email
  - phone
  - address
  - city
  - region
  - postalCode
  - domain_research  # Set to true when domain researcher has run

protected_fields:
  - domain
  - url
  - tenantId
  - uuid
  - createdAt
  - updatedAt
  - enrichmentStatus
  - enrichmentError
  - lastEnrichedAt

# ============================================================================
# CONDITIONAL FIELD UPDATES - entityName Protection Rules
# ============================================================================
# entityName requires special handling:
# - PRESERVE if existing value looks like a clean company name
# - EXTRACT CLEAN if existing value is missing, empty, or looks like a web title
#
# This prevents overwriting good Source data while still allowing discovery
# ============================================================================
conditional_update_fields:
  entityName:
    # Only update entityName if current value matches these "dirty" patterns
    update_only_if_dirty: true
    dirty_patterns:
      # Web title separators (e.g., "Company | Tagline", "Home - Company")
      - " | "
      - " - "
      - " :: "
      - " – "
      - " — "
      # Generic web page titles
      - "^Home$"
      - "^Welcome"
      - "^Official"
      - "^Please"
      # Error pages
      - "Upgrade Browser"
      - "404"
      - "Not Found"
      - "Error"
      - "Coming Soon"
      - "Under Construction"
      # Marketing claims in titles
      - "#1 "
      - "^Best "
      - "^Top "
      - "™$"
      - "®$"
    # Also update if value is just the domain (e.g., "example.com")
    update_if_matches_domain: true
    # Also update if value is empty or null
    update_if_empty: true
    # Preserve threshold - if existing name is 3-50 chars and clean, preserve it
    preserve_if_clean: true

researcher_identity:
  title: Entity Identity Analyst
  mission: Extract and validate entity identity from About, Contact, and legal pages
  ecosystem_role: Identity-focused researcher that runs last to backfill empty Domain fields
  core_competencies:
  - 'Entity Naming: Official company name extraction (PROTECT existing clean names)'
  - 'Location Intelligence: Headquarters, country from Contact/About pages'
  - 'Founding Date: Extract from launch dates, timeline, history'

# Tool guidance for this researcher
tool_guidance:
  brave_search:
    priority: low  # Domain researcher focuses on existing page content
    max_calls: 0   # No external search - use page_facts only
    when_to_use: |
      ⚠️ DO NOT USE - Domain researcher uses page content only

search_query: "company name headquarters founded contact about"

# Search queries - optimized for vector search (pre-computed embeddings)
# Each query targets a specific content pattern found on company websites
search_queries:
  # Entity name extraction
  - "What is the official company name? About us company overview who we are"

  # Headquarters/Location - multiple patterns
  - "Where is the company headquarters located? Contact us address location office"
  - "Contact us mailing address street city state zip postal code"
  - "Privacy notice how to contact us mail attention legal"

  # Founded/History
  - "When was the company founded started launched? Year established since"
  - "Company history timeline milestones growth journey"

  # Contact info
  - "Contact email phone number get in touch support"

# BM25 keyword queries - for specific keyword patterns vector search misses
# These run in ADDITION to vector queries for better recall
# Keep these short and keyword-focused (BM25 matches terms, not semantics)
keyword_queries:
  - "headquarters"
  - "founded"
  - "address"

# Focus areas for this researcher (guides LLM attention)
focus_areas:
  - "entityName: CRITICAL - Check EXISTING value FIRST. If it looks like a clean company name (e.g., 'Stripe', 'Acme Corp'), PRESERVE IT and output the same value. Only extract a NEW name if: (1) empty/null, (2) looks like web title with |, -, ::, (3) is just 'Home', 'Welcome', or error text, (4) matches the domain exactly (e.g., 'example.com')"
  - Founded year (look for "Founded in", "Established", "Since", "Launched", first funding round)
  - Headquarters location (city, state/region, country - ISO 2-letter code)
  - Contact information (email, phone, street address)
  - ALWAYS set domain_research=true to mark this entity as researched

# Fact types to extract from source content
fact_types:
  - entity_name
  - founded_year
  - headquarters
  - country
  - email
  - phone
  - address

# Avoid patterns for this researcher
avoid:
  - "OVERWRITING CLEAN entityName: If existing entityName looks like a proper company name (no pipes, no dashes with spaces, not 'Home'), KEEP IT and output the existing value"
  - "Using page title as entity name (often includes taglines, separators)"
  - "Extracting names that contain pipe, double colon, or spaced dash - these are web title patterns"
  - "Outputting entityName as just the domain (e.g., 'example.com') - find the actual company name"
  - "Guessing founded year without evidence (use 0 if not found)"
  - "Confusing regional offices with headquarters"
  - "Extracting marketing taglines as company names"
