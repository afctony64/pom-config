id: domain
type: researcher_ai
researcher_type: domain
collection_schema_id: Domain
name: Domain Identity

update_mode: true
confidence_based_update: true
execution_order: 100

output_fields:
  - entityName
  - country
  - foundedYear
  - headquarters
  - email
  - phone
  - address
  - city
  - region
  - postalCode
  - domain_research  # Set to true when domain researcher has run

protected_fields:
  - domain
  - url
  - tenantId
  - uuid
  - createdAt
  - updatedAt
  - enrichmentStatus
  - enrichmentError
  - lastEnrichedAt

# ============================================================================
# CONDITIONAL FIELD UPDATES - entityName Protection Rules
# ============================================================================
# entityName requires special handling:
# - PRESERVE if existing value looks like a clean company name
# - EXTRACT CLEAN if existing value is missing, empty, or looks like a web title
#
# This prevents overwriting good Source data while still allowing discovery
# ============================================================================
conditional_update_fields:
  entityName:
    # Only update entityName if current value matches these "dirty" patterns
    update_only_if_dirty: true
    dirty_patterns:
      # Web title separators (e.g., "Company | Tagline", "Home - Company")
      - " | "
      - " - "
      - " :: "
      - " ‚Äì "
      - " ‚Äî "
      # Generic web page titles
      - "^Home$"
      - "^Welcome"
      - "^Official"
      - "^Please"
      # Error pages
      - "Upgrade Browser"
      - "404"
      - "Not Found"
      - "Error"
      - "Coming Soon"
      - "Under Construction"
      # Marketing claims in titles
      - "#1 "
      - "^Best "
      - "^Top "
      - "‚Ñ¢$"
      - "¬Æ$"
    # Also update if value is just the domain (e.g., "example.com")
    update_if_matches_domain: true
    # Also update if value is empty or null
    update_if_empty: true
    # Preserve threshold - if existing name is 3-50 chars and clean, preserve it
    preserve_if_clean: true

researcher_identity:
  title: Entity Identity Analyst
  mission: Extract and validate entity identity from About, Contact, and legal pages
  ecosystem_role: Identity-focused researcher that runs last to backfill empty Domain fields
  core_competencies:
  - 'Entity Naming: Official company name extraction (PROTECT existing clean names)'
  - 'Location Intelligence: Headquarters, country from Contact/About pages'
  - 'Founding Date: Extract from launch dates, timeline, history'

# Tools available for this researcher
tools:
  - brave_search  # Web search for location data when not found in page_facts

# Tool guidance for this researcher
tool_guidance:
  brave_search:
    priority: medium
    max_calls: 2
    when_to_use: |
      üîç USE BRAVE SEARCH FOR LOCATION DATA (MAX 2 SEARCHES):

      **WHEN TO SEARCH:**
      - Page content has NO headquarters/location information
      - Only entityName was found, location fields are empty
      - No About/Contact pages in the page_facts

      **SEARCH #1 (LOCATION): Headquarters address**
      ‚Üí "{entityName} headquarters address location"
      Example: "Stripe headquarters address location"
      ‚Üí Returns: "San Francisco, CA" or full address

      **SEARCH #2 (IF NEEDED): Contact info**
      ‚Üí "{entityName} company contact phone email"
      Only if first search didn't include contact details

      **DO NOT SEARCH IF:**
      - Page content already has clear headquarters info
      - You found location in About/Contact page chunks

# search_query/search_queries/keyword_queries/url_boost_patterns are used by the
# page_facts_vector injector to retrieve and prioritize chunks.
search_query: "company name headquarters founded contact about"

# Search queries - optimized for vector search (pre-computed embeddings)
# Used by page_facts_vector injector.
# Each query targets a specific content pattern found on company websites
search_queries:
  # Entity name extraction
  - "What is the official company name? About us company overview who we are"

  # Headquarters/Location - multiple patterns
  - "Where is the company headquarters located? Contact us address location office"
  - "Contact us mailing address street city state zip postal code"
  - "Privacy notice how to contact us mail attention legal"

  # Founded/History
  - "When was the company founded started launched? Year established since"
  - "Company history timeline milestones growth journey"

  # Contact info
  - "Contact email phone number get in touch support"

# BM25 keyword queries - for specific keyword patterns vector search misses
# Used by page_facts_vector injector (BM25 supplements).
# These run in ADDITION to vector queries for better recall
# Keep these short and keyword-focused (BM25 matches terms, not semantics)
# BM25 is very fast (inverted index lookup) so we can have more queries
keyword_queries:
  # Location patterns
  - "headquarters"
  - "located"
  - "office"
  - "address"
  # History patterns
  - "founded"
  - "established"
  # Contact patterns
  - "contact"
  - "about"

# URL boost patterns - prioritize chunks from these page types
# Used by page_facts_vector injector.
# Customer stories match keywords but contain OTHER companies' info
# About/contact pages have the target company's actual HQ/contact info
url_boost_patterns:
  - "/about"
  - "/company"
  - "/contact"
  - "/legal"
  - "/privacy"
  - "/terms"
  - "/who-we-are"
  - "/our-story"
  - "/leadership"
  - "/team"
  - "/locations"

# Focus areas for this researcher (guides LLM attention)
focus_areas:
  - "entityName: CRITICAL - Check EXISTING value FIRST. If it looks like a clean company name (e.g., 'Stripe', 'Acme Corp'), PRESERVE IT and output the same value. Only extract a NEW name if: (1) empty/null, (2) looks like web title with |, -, ::, (3) is just 'Home', 'Welcome', or error text, (4) matches the domain exactly (e.g., 'example.com')"
  - Founded year (look for "Founded in", "Established", "Since", "Launched", first funding round)
  - |
    Headquarters location: POPULATE ALL THREE FIELDS:
    1. headquarters: Full formatted string like "San Francisco, CA, USA" or "London, UK"
    2. city: Just the city name (e.g., "San Francisco")
    3. country: ISO country code (e.g., "US", "UK", "IL")
    FIRST check page_facts for About/Contact pages. If NOT FOUND, USE brave_search to find '{entityName} headquarters address location'.
  - "Contact information: Extract email, phone, street address from Contact pages. If not found, use brave_search as fallback."
  - ALWAYS set domain_research=true to mark this entity as researched

# Fact types to extract from source content
fact_types:
  - entity_name
  - founded_year
  - headquarters
  - country
  - email
  - phone
  - address

# Avoid patterns for this researcher
avoid:
  - "OVERWRITING CLEAN entityName: If existing entityName looks like a proper company name (no pipes, no dashes with spaces, not 'Home'), KEEP IT and output the existing value"
  - "Using page title as entity name (often includes taglines, separators)"
  - "Extracting names that contain pipe, double colon, or spaced dash - these are web title patterns"
  - "Outputting entityName as just the domain (e.g., 'example.com') - find the actual company name"
  - "Guessing founded year without evidence (use 0 if not found)"
  - "Confusing regional offices with headquarters"
  - "Extracting marketing taglines as company names"
  - "CRITICAL: Extracting OTHER companies' locations as headquarters. Customer stories, partner pages, and case studies mention OTHER companies' locations - ignore these. Only extract locations explicitly about THIS company (the domain owner)."
