---
name: Parallel Array Enricher
id: parallel_array_enricher
description: "Schema-driven enricher for parallel array elements. Uses field descriptions to guide searches."

stage: post_execution
reusable: true
category: enrich

classification:
  task_type: extraction
  complexity: low
  context_size: small
  priority: speed

version: 1.2.0
authors:
  - AI Assistant

inputs:
  element:
    description: "The anchor element to deep-dive on (e.g., 'Boomi', 'John Smith')"
    type: string
  anchor_field:
    description: "The anchor field name (e.g., 'keyCompetitors', 'keyExecutives')"
    type: string
  row_context:
    description: "All parallel array data for this row (LLM-filled fields)"
    type: object
  post_fields:
    description: "Array of {name, description} for fields to fill"
    type: array
  tenant_context:
    description: "Tenant context (name, industry_focus)"
    type: object
  researcher_context:
    description: "Researcher context (title, mission)"
    type: object
  source_context:
    description: "Source entity context (domain, title, industry)"
    type: object

# Tools the LLM can call to search for specific field data
tools:
  - brave_search

tool_guidance:
  brave_search:
    priority: high
    max_calls: 3
    when_to_use: |
      Use brave_search to find specific data for each field based on its description.
      
      **READ THE FIELD DESCRIPTIONS** - they contain search guidance!
      Examples of what to look for in descriptions:
      - "official website domain" → Search: "{element} {industry} official website"
      - "LinkedIn profile" → Search: "{element} linkedin profile" (+ role if known)
      - "company size" → Search: "{element} employees company size"
      
      **DISAMBIGUATION:**
      - For common names, include: {source_context.title} and {source_context.industry}
      - For competitors: include the industry vertical

data_requirements:
  include_enrichment_data: true
  injectors:
    # Page facts - broad search without domain filter
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        inject_as: page_facts_response
        limit: 10
        search_query: "{{ element }}{% if row_context %}{% for _key, value in row_context.items() %} {{ value }}{% endfor %}{% endif %}"
        search_strategy: hybrid
        domain: "{{ source_context.domain }}"
      search:
        type: hybrid
        alpha: 0.5
        query: "{{ element }}{% if row_context %}{% for _key, value in row_context.items() %} {{ value }}{% endfor %}{% endif %}"
  
  error_handling:
    missing_data: "continue"
    empty_results: "continue"
    api_failures: "continue"

outputs:
  fields:
    type: object
    description: "Object with field values keyed by field name"

model:
  api: chat
  configuration:
    connection: openai_conn
    model: gpt-5-nano
    type: openai_chat
  parameters:
    response_format:
      type: json_object
    max_retries: 2

---

system:
You are enriching a single record for **{{ element }}**.

Context:
- Tenant: {{ tenant_context.name|default('Unknown') }}
- Researcher: {{ researcher_context.title|default('Unknown') }}

Fields to fill (use descriptions for search guidance):
{% for field in post_fields %}
- {{ field.name }}: {{ field.description }}
{% endfor %}

Rules:
- Use page_facts first when relevant.
- If web lookup is required, use brave_search.
- Treat "{{ element }}" as the only company name to search for. Do not search for other competitors.
- Replace {element} in ENRICHMENT SEARCH templates with "{{ element }}".
- Return JSON with ONLY the fields listed above. Use null if not found.

user:
**SUBJECT:** {{ element }}

{% if page_facts_response is defined and page_facts_response %}
**PAGE FACTS (top 5):**
{% for fact in page_facts_response[:5] %}
- {% if fact.content is defined %}{{ fact.content|truncate(200) }}{% elif fact.get is defined %}{{ fact.get('content')|default(fact.get('properties', {}).get('content', ''))|truncate(200) }}{% endif %}
{% endfor %}
{% endif %}

**INSTRUCTIONS:**
1. Fill the fields for **{{ element }}** only.
2. Use page_facts if available; otherwise use brave_search.
3. Follow the field descriptions for search terms and formatting.
4. Every brave_search query MUST include "{{ element }}" and no other competitor names.

Return JSON with ONLY these exact field names:
```json
{
{% for field in post_fields %}
  "{{ field.name }}": "value or null"{% if not loop.last %},{% endif %}

{% endfor %}
}
```
