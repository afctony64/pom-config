---
name: Parallel Array Enricher
id: parallel_array_enricher
description: "Schema-driven enricher for parallel array elements. Uses field descriptions to guide searches."

stage: post_execution
reusable: true
category: enrich

classification:
  task_type: extraction
  complexity: low
  context_size: small
  priority: speed

version: 1.3.0
authors:
  - AI Assistant

inputs:
  subject:
    description: "The anchor subject to deep-dive on (e.g., 'Boomi', 'John Smith')"
    type: string
  anchor_field:
    description: "The anchor field name (e.g., 'keyCompetitors', 'keyExecutives')"
    type: string
  post_fields:
    description: "Array of {name, description} for fields to fill"
    type: array
  # Context injection (same as main prompts)
  tenant:
    description: "TenantConfig object (injected from tenant_id)"
    type: object
  researcher_ai:
    description: "ResearcherAIConfig with researcher_identity (injected from researcher_id)"
    type: object
  record:
    description: "Source record being enriched (Domain or Research_* record)"
    type: object
  execution_artifacts:
    description: "Canonical execution artifacts (prompt, llm_context, llm_response, tools)"
    type: object

# Tools available for additional field enrichment (NOT for domain resolution)
# Domain is resolved via: 1) pre-resolved subject_domain OR 2) pre-injected domain_candidates
tools:
  - brave_search

tool_guidance:
  brave_search:
    priority: medium
    max_calls: 3
    when_to_use: |
      **DO NOT use brave_search for domain resolution** - use subject_domain or domain_candidates instead.

      Use brave_search ONLY when:
      - page_facts are missing or insufficient for NON-DOMAIN fields
      - You need fresh data for specific field values (e.g., positioning, funding)

      Search strategy per field:
      1. Extract key terms from the field description
      2. Search: "{subject} [key terms from description]"
      3. For well-known subjects, general knowledge is acceptable as fallback

data_requirements:
  include_enrichment_data: true
  injectors:
    # Domain candidates - pre-search for official domain before LLM runs
    # Only runs if subject_domain is not already resolved (skips if we have the domain)
    - injector_template: mcp
      skip_if: "{{ 'true' if (subject_domain is defined and subject_domain) else 'false' }}"
      template_vars:
        tool: brave_search
        params:
          query: "{{ subject }} {% if tenant and tenant.description %}{{ tenant.description[:100] }}{% endif %} official website domain"
          count: 5
        inject_as: domain_candidates
    # Page facts - search using field descriptions
    # Use resolved_domains (all resolved competitor domains) as market filter
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        inject_as: page_facts_response
        limit: 20
        search_query: "{% set props = record.get('properties') or record if record else {} %}{% set entity_name = props.get('entityName') or props.get('domain') or '' %}{% for field in post_fields %}{{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}{% if not loop.last %} | {% endif %}{% endfor %}"
        search_strategy: hybrid
        # Use resolved_domains list (all resolved entity domains) for market-wide filter
        # This provides full context from all related entity page_facts
        domains: "{{ resolved_domains if resolved_domains is defined and resolved_domains else [] }}"
      search:
        type: hybrid
        alpha: 0.5
        query: "{% set props = record.get('properties') or record if record else {} %}{% set entity_name = props.get('entityName') or props.get('domain') or '' %}{% for field in post_fields %}{{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}{% if not loop.last %} | {% endif %}{% endfor %}"

  error_handling:
    missing_data: "continue"
    empty_results: "continue"
    api_failures: "continue"

outputs:
  fields:
    type: object
    description: "Object with field values keyed by field name"

model:
  api: chat
  configuration:
    connection: openai_conn
    model: gpt-5-mini
    type: openai_chat
  parameters:
    response_format:
      type: json_object
    max_retries: 2

---

system:
You are enriching a single record for **{{ subject }}**.

{% set props = record.get('properties') or record if record else {} %}
{% set entity_name = props.get('entityName') or props.get('domain') or 'Unknown' %}
{% set tenant_name = tenant.name|default(tenant.id) if tenant else 'Unknown' %}
{% set tenant_industry = (tenant|attr('industry_focus'))|default(props.get('industry') if props else '') %}
{# Detect the domain field name dynamically from post_fields (e.g., competitorDomain, customerDomain, partnerDomain) #}
{% set ns = namespace(domain_field='') %}
{% for field in post_fields %}{% if 'Domain' in field.name and ns.domain_field == '' %}{% set ns.domain_field = field.name %}{% endif %}{% endfor %}
{% set domain_field_name = ns.domain_field %}

Context:
{% if tenant %}- Tenant: {{ tenant.name|default(tenant.id) }}{% if tenant.description %} - {{ tenant.description }}{% endif %}{% endif %}
{% if researcher_ai and researcher_ai.researcher_identity %}- Researcher: {{ researcher_ai.researcher_identity.title }} - {{ researcher_ai.researcher_identity.mission }}{% endif %}
- Source Entity: {{ entity_name }}

**DOMAIN RESOLUTION (3 modes):**
{% if person_domain is defined and person_domain %}
üßë **PERSON MODE:** {{ subject }} is a person. Use {{ subject_domain }} only as a LinkedIn hint.
{% elif subject_domain is defined and subject_domain %}
‚úÖ **MODE 1 - RESOLVED:** Domain for {{ subject }} is **{{ subject_domain }}**. Use page_facts only.
{% else %}
üìã **MODE 2 - CANDIDATES:** Pick domain from pre-searched DOMAIN CANDIDATES in user message.
{% endif %}

Fields to fill:
{% for field in post_fields %}
- {{ field.name }}: {{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}
{% endfor %}

Rules:
{% if subject_domain is defined and subject_domain and not (person_domain is defined and person_domain) %}
- **MODE 1**: Domain resolved. Use page_facts only. Do NOT call brave_search.
{% elif person_domain is defined and person_domain %}
- **PERSON MODE**: Use brave_search for LinkedIn profile/background/tenure. Use {{ subject_domain }} as a hint.
{% else %}
- **MODE 2**: Pick {{ domain_field_name }} from DOMAIN CANDIDATES (match title to {{ tenant_industry }} context).
- For other fields: Use page_facts first, then brave_search if needed.
{% endif %}
{% if domain_field_name %}- **CRITICAL**: {{ domain_field_name }} must NEVER equal "{{ entity_name }}" (the source entity). {{ subject }} is a DIFFERENT entity.{% endif %}
- Extract just domain from URLs (e.g., "useparagon.com" from "https://www.useparagon.com/")
- Prefer official company sites over linkedin/crunchbase/ycombinator
- Do NOT include citations or inline URLs in field values unless the field explicitly expects a URL (e.g., domain or LinkedIn fields). Put sources in evidence/CIT fields.
- Return JSON with ONLY the fields listed above. NEVER use null - use the fallback value specified in each field description.

user:
**SUBJECT:** {{ subject }}
{% if subject_domain is defined and subject_domain %}**SUBJECT DOMAIN:** {{ subject_domain }}{% endif %}

{% if domain_candidates is defined and domain_candidates and domain_candidates.results is defined %}
**DOMAIN CANDIDATES FOR {{ subject }} (pre-searched - pick the correct one):**
{% for result in domain_candidates.results[:5] %}
- {{ result.url }} | {{ result.title }}
{% endfor %}
{% endif %}

{% if page_facts_response is defined and page_facts_response %}
{% if has_subject_page_facts is defined and has_subject_page_facts %}
**PAGE FACTS FROM {{ subject_domain }} ({{ page_facts_response|length }} facts - PREFERRED SOURCE):**
{% else %}
**PAGE FACTS (top 5):**
{% endif %}
{% for fact in page_facts_response[:10] %}
- {% if fact.content is defined %}{{ fact.content|truncate(300) }}{% elif fact.get is defined %}{{ fact.get('content')|default(fact.get('properties', {}).get('content', ''))|truncate(300) }}{% endif %}
{% endfor %}
{% endif %}

**INSTRUCTIONS:**
{% set source_domain = props.get('domain', '') %}
{% if domain_field_name %}‚ö†Ô∏è **NEVER use "{{ source_domain }}" as {{ domain_field_name }}** - that is the SOURCE entity, not {{ subject }}.{% endif %}

{% if subject_domain is defined and subject_domain and not (person_domain is defined and person_domain) %}
**MODE 1 - DOMAIN RESOLVED:** {{ subject_domain }}
1. Use {{ domain_field_name }} = "{{ subject_domain }}"
2. Extract other fields from page_facts only. Do NOT call brave_search.
{% elif person_domain is defined and person_domain %}
**PERSON MODE - LINKEDIN SEARCH:**
1. Use brave_search to find the best LinkedIn profile for {{ subject }}.
2. Use {{ subject_domain }} as a hint only; verify with search results.
3. Fill person fields (LinkedIn, background, tenure) from search/page_facts.
{% elif domain_candidates is defined and domain_candidates and domain_candidates.results is defined %}
**MODE 2 - PICK FROM CANDIDATES:**
1. For {{ domain_field_name }}: Pick the official company website from DOMAIN CANDIDATES above.
   - Match title to {{ subject }} in the context (e.g., "Integration Infrastructure" for iPaaS)
   - Extract just domain (e.g., "useparagon.com" from "https://www.useparagon.com/")
   - **NEVER pick {{ source_domain }}** - that is the source entity, not {{ subject }}
   - Ignore linkedin, crunchbase, ycombinator, etc.
2. For other fields: Use page_facts, then brave_search if needed.
{% else %}
1. Use page_facts if available, otherwise brave_search.
{% if domain_field_name %}2. For {{ domain_field_name }}: Extract official domain from search results.
   - **NEVER use {{ source_domain }}** - that is the source entity{% endif %}
{% endif %}

Return JSON with ONLY these exact field names (use fallback values from descriptions, never null):
```json
{
{% for field in post_fields %}
  "{{ field.name }}": "value"{% if not loop.last %},{% endif %}

{% endfor %}
}
```
