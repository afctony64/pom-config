---
name: Parallel Array Enricher
id: parallel_array_enricher
description: "Schema-driven enricher for parallel array elements. Uses field descriptions to guide searches."

stage: post_execution
reusable: true
category: enrich

classification:
  task_type: extraction
  complexity: low
  context_size: small
  priority: speed

version: 1.2.0
authors:
  - AI Assistant

inputs:
  subject:
    description: "The anchor subject to deep-dive on (e.g., 'Boomi', 'John Smith')"
    type: string
  anchor_field:
    description: "The anchor field name (e.g., 'keyCompetitors', 'keyExecutives')"
    type: string
  post_fields:
    description: "Array of {name, description} for fields to fill"
    type: array
  # Context injection (same as main prompts)
  tenant:
    description: "TenantConfig object (injected from tenant_id)"
    type: object
  researcher_ai:
    description: "ResearcherAIConfig with researcher_identity (injected from researcher_id)"
    type: object
  record:
    description: "Source record being enriched (Domain or Research_* record)"
    type: object
  execution_artifacts:
    description: "Canonical execution artifacts (prompt, llm_context, llm_response, tools)"
    type: object
    type: object

# Tools the LLM can call to search for specific field data
tools:
  - brave_search

tool_guidance:
  brave_search:
    priority: high
    max_calls: 5
    when_to_use: |
      Use brave_search when page_facts are missing or insufficient for a field.
      Always use brave_search to confirm the domain for {subject}.
      Prefer official company root domains over hosted subdomains.
      
      **READ THE FIELD DESCRIPTIONS** - they contain search guidance!
      For common names, add the tenant name and industry vertical to disambiguate.
      Examples of what to look for in descriptions:
      - "official website domain" → Search: "{subject} {industry} official website"
      - "LinkedIn profile" → Search: "{subject} linkedin profile" (+ role if known)
      - "company size" → Search: "{subject} employees company size"

data_requirements:
  include_enrichment_data: true
  injectors:
    # Page facts - search using field descriptions
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        inject_as: page_facts_response
        limit: 10
        search_query: "{% set props = record.get('properties') or record if record else {} %}{% set entity_name = props.get('entityName') or props.get('domain') or '' %}{% for field in post_fields %}{{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}{% if not loop.last %} | {% endif %}{% endfor %}"
        search_strategy: hybrid
        domain: "{{ (record.get('properties') or record).get('domain', '') if record else '' }}"
      search:
        type: hybrid
        alpha: 0.5
        query: "{% set props = record.get('properties') or record if record else {} %}{% set entity_name = props.get('entityName') or props.get('domain') or '' %}{% for field in post_fields %}{{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}{% if not loop.last %} | {% endif %}{% endfor %}"
  
  error_handling:
    missing_data: "continue"
    empty_results: "continue"
    api_failures: "continue"

outputs:
  fields:
    type: object
    description: "Object with field values keyed by field name"

model:
  api: chat
  configuration:
    connection: openai_conn
    model: gpt-5-mini
    type: openai_chat
  parameters:
    response_format:
      type: json_object
    max_retries: 2

---

system:
You are enriching a single record for **{{ subject }}**.

Prompt definition:
Use the context and search to provide answers for each listed field for the subject. Return JSON with those fields only.

Context:
{% if execution_artifacts is defined and execution_artifacts and execution_artifacts.system_prompt %}
{{ execution_artifacts.system_prompt }}
{% if execution_artifacts.prompt %}

Prior prompt (full):
{{ execution_artifacts.prompt }}
{% endif %}
{% else %}
{% if tenant %}- Tenant: {{ tenant.name|default(tenant.id) }}{% if tenant.description %} - {{ tenant.description }}{% endif %}{% endif %}
{% if researcher_ai and researcher_ai.researcher_identity %}- Researcher: {{ researcher_ai.researcher_identity.title }} - {{ researcher_ai.researcher_identity.mission }}{% endif %}
{% if record %}{% set props = record.get('properties') or record %}- Entity: {{ props.get('entityName') or props.get('domain') or 'Unknown' }}{% endif %}
{% endif %}

Prior context to reuse:
{% if execution_artifacts is defined and execution_artifacts %}
- Use execution_artifacts as broad comparison context (it already surfaced {{ subject }}).
- Combine it with new, direct evidence from page_facts and brave_search for {{ subject }}.
{% endif %}

{% set props = record.get('properties') or record if record else {} %}
{% set entity_name = props.get('entityName') or props.get('domain') or 'Unknown' %}
{% set tenant_name = tenant.name|default(tenant.id) if tenant else 'Unknown' %}
{% set tenant_industry = (tenant|attr('industry_focus'))|default(props.get('industry') if props else '') %}
{% set entity = entity_name %}
Data injection queries ({{ entity }} context):
{% for field in post_fields %}
{% if not field.name.endswith('Evidence') %}
{% set raw_desc = field.description|replace('{subject}', subject)|replace('{entity}', entity_name) %}
{% set base_desc = raw_desc.split('Examples:')[0].split('Example:')[0].strip() %}
- {{ base_desc }}
{% endif %}
{% endfor %}

Fields to fill ({{ entity }} context):
{% for field in post_fields %}
- {{ field.name }}: {{ field.description|replace('{subject}', subject)|replace('{entity}', entity_name) }}
{% endfor %}

Disambiguation:
- Include tenant context ({{ tenant_name }}) and industry when relevant{% if tenant_industry %} ({{ tenant_industry }}){% endif %}
- For ambiguous names (common company/person names), add context from the anchor field ({{ anchor_field }})

Rules:
- Use page_facts first when relevant.
- Use brave_search when page_facts are missing or insufficient.
- Always use brave_search to confirm the domain for {{ subject }}.
- Every brave_search query MUST include "{{ subject }}". Include {{ tenant_name }} when relevant.
- For domains: prefer official root domains over hosted subdomains.
- For LinkedIn: search "{subject} linkedin profile" with role/company context.
- Use execution_artifacts as broad context, then add direct evidence from page_facts/brave_search for {{ subject }}.
- **CRITICAL: EXTRACT DATA FROM SEARCH RESULTS.** If brave_search returns descriptions, pricing info, positioning claims, or target market info - USE IT. Do not return "Not disclosed" when data is available.
- Infer from messaging when explicit data isn't stated (e.g., "enterprise" from enterprise pricing page, positioning from taglines).
- Return JSON with ONLY the fields listed above. Use null ONLY if truly no relevant data found after searching.

user:
**SUBJECT:** {{ subject }}

{% if page_facts_response is defined and page_facts_response %}
**PAGE FACTS (top 5):**
{% for fact in page_facts_response[:5] %}
- {% if fact.content is defined %}{{ fact.content|truncate(200) }}{% elif fact.get is defined %}{{ fact.get('content')|default(fact.get('properties', {}).get('content', ''))|truncate(200) }}{% endif %}
{% endfor %}
{% endif %}

**INSTRUCTIONS:**
1. Use the context and search to answer each listed field for **{{ subject }}** only.
2. Use page_facts if available; otherwise use brave_search.
3. Follow the field descriptions for formatting.
4. Always use brave_search to confirm the domain for **{{ subject }}**.
5. Every brave_search query MUST include "{{ subject }}".
6. Prioritize direct evidence about {{ subject }} over generic summaries.
7. **EXTRACT DATA FROM RESULTS:** When brave_search returns info about {{ subject }}, use it! Extract details from taglines, bios, official pages, and profiles. Do NOT say "Not disclosed" if the search returned relevant data.

Return JSON with ONLY these exact field names:
```json
{
{% for field in post_fields %}
  "{{ field.name }}": "value or null"{% if not loop.last %},{% endif %}

{% endfor %}
}
```
