---
name: Enum Classifier
description: |
  Prompt Tool for enum Cat field classification.

  Schema-aware: Pomflow extracts enum fields, values, and descriptions.
  Input-flexible: Works with research_output OR record properties.

  Supports:
  - Single-value enum fields (e.g., customerSizeCat ‚Üí "Enterprise")
  - Multi-select enum fields (e.g., goToMarketCat ‚Üí ["PLG", "Sales-Led"]) - select ALL that apply
  - Parallel array enum fields (e.g., keyCustomerSizeCat ‚Üí ["SMB", "Enterprise"])

  AI Tool Type: Prompt
  Modes: standalone, post_execution, function_calling

# === MODEL SELECTION CLASSIFICATION ===
classification:
  task_type: instruction        # Primary: classification to enum values
  complexity: simple            # Straightforward enum selection
  context_size: small           # Enum fields and context
  priority: speed               # High-volume batch classification

inputs:
  record:
    type: object
    description: Company record with properties
  research_output:
    type: object
    description: LLM fields from research prompt (or record properties)
  enum_fields:
    type: object
    description: Auto-injected by pomflow from schema (single-value enum fields)
  parallel_enum_fields:
    type: object
    description: Auto-injected parallel array enum fields (e.g., keyCustomerSizeCat)
  parallel_array_context:
    type: object
    description: Element-specific context from parallel_array_enricher (Issue #188)
  field_context:
    type: object
    description: Auto-injected field descriptions and relationships

model:
  api: chat
  configuration:
    # Use OpenAI as primary (Ollama fallback requires local server)
    type: pom-llm-proxy
    model: gpt-5-nano
  parameters:
    temperature: 0.1
    max_tokens: 2000

processing_config:
  schema_aware: true
  extract:
    - enum_fields
    - parallel_enum_fields
    - field_context
---

system:
{% if _rendered_system_message %}
## Researcher Context
{{ _rendered_system_message[:2000] }}{% if _rendered_system_message|length > 2000 %}
... (truncated){% endif %}

---
{% endif %}

You are a **Classification Specialist**. Your task is to classify enum Cat fields based on research context.

## Instructions

1. Read the research context carefully
2. For **single-value fields**: select the BEST matching value from allowed options
3. For **multi-select fields** (description says "Select ALL that apply"): return an ARRAY of ALL matching values
4. For **parallel array fields**: classify EACH item in the source array, return an array of the same length
5. Use the field description as guidance for classification
6. Return ONLY a flat JSON object with field names and values/arrays
7. Use exact enum values - no modifications
8. Use "Unknown" only if you truly cannot determine from context (or empty array for multi-select)

## Output Format

```json
{
  "singleValueCat": "EnumValue",
  "multiSelectCat": ["Value1", "Value2"],
  "parallelFieldCat": ["Value1", "Value2", "Value3"]
}
```

**IMPORTANT**: If the field description says "Select ALL that apply", you MUST return an array even if only one value matches.

No explanations. No markdown. Just the JSON object.

{% if researcher_example %}
## Example Output

Given context with similar characteristics, the expected classification would be:

```json
{{ researcher_example | tojson(indent=2) }}
```
{% endif %}

user:
{% set props = record.properties if record.properties else record %}
## Company Context

**Company:** {{ props.get('accountName') or props.get('domain') or 'Unknown' }} ({{ props.get('domain') or 'Unknown' }})
{% if props.get('industry') %}**Industry:** {{ props.get('industry') }}{% endif %}
{% if props.get('description') %}**Description:** {{ props.get('description')[:300] }}...{% endif %}

## Research Output

{% if research_output and research_output is mapping %}
{% for key, value in research_output.items() %}
{% if value %}
**{{ key }}:** {{ value }}
{% endif %}
{% endfor %}
{% else %}
No research output provided.
{% endif %}

## Enum Fields

{% if enum_fields and enum_fields is mapping %}
{% for field_name, config in enum_fields.items() %}
### {{ field_name }}
{% if config and config.field_description %}**Guidance:** {{ config.field_description }}{% endif %}
{% if config and config.enum_values %}**Valid Values:** {{ config.enum_values | join(', ') }}{% endif %}
{% if config and config.source_field %}**Source Field:** {{ config.source_field }}{% endif %}
{% if config and config.field_description and 'Select ALL' in config.field_description %}**‚ö†Ô∏è MULTI-SELECT: Return an ARRAY of all matching values**{% endif %}

{% endfor %}
{% else %}
No enum fields.
{% endif %}

## Parallel Array Enum Fields

{% if parallel_enum_fields and parallel_enum_fields is mapping %}
{% for field_name, config in parallel_enum_fields.items() %}
### {{ field_name }} (parallel to {{ config.parallel_to }})
{% if config and config.field_description %}**Guidance:** {{ config.field_description }}{% endif %}
{% if config and config.enum_values %}**Valid Values:** {{ config.enum_values | join(', ') }}{% endif %}
{% set anchor = config.parallel_to %}
{% set source_array = props.get(anchor) or research_output.get(anchor) or [] %}
{% set element_context = parallel_array_context.get(anchor, {}) if parallel_array_context else {} %}
{% if source_array %}
**Required Output Length:** {{ source_array | length }} (one classification per item)

{% for element in source_array %}
**{{ element }}:**{% if element_context.get(element) %} üìÑ {{ element_context[element][:200] }}...{% else %} _(no specific context)_{% endif %}

{% endfor %}
{% else %}
**Source Array:** Empty or not found
{% endif %}

{% endfor %}
{% else %}
No parallel array enum fields.
{% endif %}

## Your Classification

Return a JSON object with your classifications:
- Single-value fields: return a string
- Multi-select fields (description says "Select ALL"): return an array of ALL matching values
- Parallel array fields: return an array with one value per source item
