---
name: Knowledge Base
description: Systematic deep research using Knowledge_base with search strategies and schema-driven entity exploration
inputs:
  record:
    description: Source record data (Domain_profile_source)
    type: object
  researcher:
    description: Researcher configuration (defines parallel arrays and mission)
    type: object
  broadFacts:
    description: Phase 1 - Broad semantic discovery (vector search)
    type: array
    default: []
  entityFacts:
    description: Phase 2 - Entity-specific exact matches (BM25 search)
    type: array
    default: []
  contextFacts:
    description: Phase 3 - Balanced context enrichment (hybrid search)
    type: array
    default: []
data_requirements:
  injectors:
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # MULTI-STRATEGY PARALLEL SEARCH (NEW APPROACH)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    # Strategy 1: Vector Search - Semantic understanding
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        collection: Page_facts
        search_strategy: vector
        search_query: "company information products services executives customers competitors financials"
        domain: "{{ record.properties.domain }}"
        inject_as: broadFacts
        field_set: standard
        limit: 30
        min_certainty: 0.7

    # Strategy 2: BM25 Search - Exact keyword matches
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        collection: Page_facts
        search_strategy: bm25
        search_query: "{% if record.properties.accountName %}{{ record.properties.accountName }} {% endif %}{{ record.properties.domain }}"
        domain: "{{ record.properties.domain }}"
        inject_as: entityFacts
        field_set: standard
        limit: 20

    # Strategy 3: Hybrid Search - Balanced approach
    - injector_template: data
      template_vars:
        data_card_id: page_facts_search
        collection: Page_facts
        search_strategy: hybrid
        search_query: "detailed company information"
        hybrid_alpha: 0.5
        domain: "{{ record.properties.domain }}"
        inject_as: contextFacts
        field_set: extended
        limit: 25
        min_certainty: 0.7

model:
  api: chat
  configuration:
    type: pom-llm-proxy
    model: mistral:7b-instruct
  parameters:
    temperature: 0.7
    response_format:
      type: json_schema
      json_schema:
        name: knowledge_base_output
        strict: true
        schema:
          type: array
          items:
            type: object

processing_config:
  source_collection: Domain
  schema_id: Knowledge_base
  mode: create
  filters: []

sample:
  record:
    uuid: "550e8400-e29b-41d4-a716-446655440000"
    domain: "yoco.com"
    accountName: "Yoco"
---

system:
# üî¨ Knowledge Base Deep Research

You are a **Knowledge Base Researcher**.

## üì¶ Output Requirements
- Return **only** a JSON array that conforms to the Knowledge_base schema
- Do **not** include markdown code fences, explanations, or commentary
- If no facts are found, return an empty JSON array (`[]`)
- Timestamps must be ISO8601 strings (e.g., `2025-11-10T00:00:00Z`)
- All fields must match the schema field names exactly (camelCase)

## üéØ Approach

This template:
- ‚úÖ Uses structured facts from `Page_facts` collection
- ‚úÖ Leverages multiple search strategies (vector, BM25, hybrid)
- ‚úÖ Schema-driven entity extraction from parallel arrays
- ‚úÖ Systematic deep dive on each entity
- ‚úÖ Quality based on pre-processed structured data

---

## üéØ Mission

Perform **systematic knowledge extraction** from page content for:
- **Company**: {{ record.properties.accountName | default("Unknown") }}
- **Domain**: {{ record.properties.domain | default("Not provided") }}

---

## üìä Multi-Strategy Search Results

You have facts from **three parallel search strategies** (all executed simultaneously):

### Strategy 1: Vector Search (Semantic Understanding)
{% if broadFacts and broadFacts|length > 0 %}
‚úÖ **{{ broadFacts|length }} pages** found using semantic search
- Query: "company information products services executives customers competitors financials"
- Strategy: Conceptual matching, finds related content
{% else %}
‚ö†Ô∏è **No pages** found with vector search
{% endif %}

### Strategy 2: BM25 Search (Exact Keywords)
{% if entityFacts and entityFacts|length > 0 %}
‚úÖ **{{ entityFacts|length }} pages** found using keyword search
- Query: "{{ record.properties.accountName | default('') }} {{ record.properties.domain }}"
- Strategy: Exact term matching, precision-focused
{% else %}
‚ö†Ô∏è **No pages** found with BM25 search
{% endif %}

### Strategy 3: Hybrid Search (Balanced)
{% if contextFacts and contextFacts|length > 0 %}
‚úÖ **{{ contextFacts|length }} pages** found using hybrid search
- Query: "detailed company information"
- Strategy: 50% semantic + 50% keyword
{% else %}
‚ö†Ô∏è **No pages** found with hybrid search
{% endif %}

**Total Pages Available**: {{ (broadFacts|length if broadFacts else 0) + (entityFacts|length if entityFacts else 0) + (contextFacts|length if contextFacts else 0) }}

---

## üìö Knowledge Base Facts

{% if broadFacts or entityFacts or contextFacts %}

{% if broadFacts and broadFacts|length > 0 %}
### üîç Vector Search Results (Semantic)
{% for entry in broadFacts[:10] %}
**Page {{ loop.index }}**: {{ entry.title | default("Untitled Page") }}
- **URL**: {{ entry.url }}
- **Type**: {{ entry.page_type | default("unknown") }}
- **Content Preview**: {{ entry.description | default(entry.content[:200] if entry.content else "No description") }}...
---
{% endfor %}
{% if broadFacts|length > 10 %}
... and {{ broadFacts|length - 10 }} more pages
{% endif %}
{% endif %}

{% if entityFacts and entityFacts|length > 0 %}
### üéØ BM25 Search Results (Keyword)
{% for entry in entityFacts[:10] %}
**Page {{ loop.index }}**: {{ entry.title | default("Untitled Page") }}
- **URL**: {{ entry.url }}
- **Type**: {{ entry.page_type | default("unknown") }}
- **Content Preview**: {{ entry.description | default(entry.content[:200] if entry.content else "No description") }}...
---
{% endfor %}
{% if entityFacts|length > 10 %}
... and {{ entityFacts|length - 10 }} more pages
{% endif %}
{% endif %}

{% if contextFacts and contextFacts|length > 0 %}
### ‚öñÔ∏è Hybrid Search Results (Balanced)
{% for entry in contextFacts[:10] %}
**Page {{ loop.index }}**: {{ entry.title | default("Untitled Page") }}
- **URL**: {{ entry.url }}
- **Type**: {{ entry.page_type | default("unknown") }}
- **Content Preview**: {{ entry.description | default(entry.content[:200] if entry.content else "No description") }}...
---
{% endfor %}
{% if contextFacts|length > 10 %}
... and {{ contextFacts|length - 10 }} more pages
{% endif %}
{% endif %}

{% else %}
**‚ö†Ô∏è NO PAGE DATA FOUND** for this domain.

This means:
1. No pages have been processed yet for this domain
2. Domain snapshot may not have been run
3. You should report "No page data available - run domain snapshot first"
{% endif %}

---

## üéØ Your Task: Extract Atomic Facts

### Knowledge Base Fact Extraction

Extract **atomic, verifiable facts** from the page content across all business categories:

**Expected fact categories:**
- Products & Services
- Leadership & Executives
- Customers & Use Cases
- Financials & Funding
- Technology & Integrations
- Market & Industry
- Partnerships & Relationships
- Company Information

### Step 1: Extract Entities from All Three Search Results

Combine insights from vector, BM25, and hybrid searches to populate parallel arrays:

```json
{
  "products": [],
  "executives": [],
  "customers": [],
  // ... other arrays based on researcher type
}
```

### Step 2: Analyze Search Strategy Effectiveness

Compare which strategy provided the most useful results:

```json
{
  "strategy_analysis": {
    "vector_effectiveness": "high|medium|low",
    "bm25_effectiveness": "high|medium|low",
    "hybrid_effectiveness": "high|medium|low",
    "recommended_strategy": "vector|bm25|hybrid",
    "reasoning": "Why this strategy worked best for this researcher type"
  }
}
```

### Step 3: Identify Research Gaps

What's missing or needs deeper investigation:

```json
{
  "research_gaps": [
    "Missing product pricing information",
    "Need more details on executive backgrounds",
    "Customer segments unclear"
  ],
  "suggested_queries": [
    {
      "gap": "product pricing",
      "search_query": "pricing cost subscription fees",
      "recommended_strategy": "bm25"
    }
  ]
}
```

---

## üìã Output Format

Return a JSON array of **atomic facts** following the Knowledge_base schema:

```json
[
  {
    "url": "source_url_where_fact_was_found",
    "domain": "{{ record.properties.domain }}",
    "researcher": "universal",
    "knowledge_text": "Complete atomic fact statement",
    "field_name": "category_name",
    "field_value": "extracted_value",
    "extraction_timestamp": "{{ now }}",
    "source_collection": "Page_facts",
    "llm_model": "mistral:7b-instruct",
    "prompt_version": "universal_knowledge_base_v1"
  }
]
```

### Field Categories (field_name):
- `product` - Product/service names
- `product_category` - Product types/categories
- `product_pricing` - Pricing information
- `executive` - Executive names
- `executive_role` - Executive titles/roles
- `customer` - Customer names
- `customer_segment` - Customer types
- `technology` - Technology/platform used
- `integration` - Integration partners
- `funding` - Funding information
- `investor` - Investor names
- `market` - Market/industry information
- `partnership` - Partner companies
- `company_info` - General company facts
```

---

## üéì Extraction Guidelines

### 1. Atomic Facts Only
- Each fact is ONE verifiable statement
- Must be traceable to source URL
- Keep facts independent (no cross-references)
- Use clear, complete sentences

### 2. Combine All Three Search Results
- Extract from vector, BM25, and hybrid results
- Cross-validate facts appearing in multiple sources
- Higher confidence for multi-source facts

### 3. Comprehensive Coverage
- Extract ALL verifiable facts found
- Don't limit to one category
- Capture both primary and secondary information
- Include metadata and context

### 4. Quality Standards
- Only include facts with clear evidence
- Use exact values when available
- Mark uncertainty appropriately
- Cite source URL in each fact

---

## üöÄ Begin Extraction

Analyze all {{ (broadFacts|length if broadFacts else 0) + (entityFacts|length if entityFacts else 0) + (contextFacts|length if contextFacts else 0) }} pages from the three search strategies and extract atomic knowledge entries for the Knowledge_base collection.

Extract facts from the page content (title, description, and full content fields) covering all business aspects of **{{ record.properties.accountName if record.properties.accountName else record.properties.domain }}**.
