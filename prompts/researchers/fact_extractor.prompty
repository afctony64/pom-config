---
name: Fact Extractor
description: Extract atomic facts from content chunks - outputs Entity_facts records
inputs:
  record:
    description: Source record data (Domain)
    type: object
  researcher:
    description: Researcher configuration
    type: object
  semanticChunks:
    description: Content chunks to extract facts from (injected by context manager)
    type: array
    default: []
  context_strategy:
    description: Context management strategy being used
    type: string
    default: "all_chunks"

# ðŸ”§ Data injection - fetch semantic chunks from Page_facts for domain
# NOTE: skip_if prevents re-fetch when context manager has pre-injected data
data_requirements:
  injectors:
    - injector_template: data
      skip_if: "{{ semanticChunks is defined and semanticChunks | length > 0 }}"
      template_vars:
        data_card_id: page_facts_search
        domain: "{{ record.properties.domain if (record.properties is defined and record.properties.domain is defined) else (record.domain | default('')) }}"
        search_strategy: hybrid
        query_text: "company products services features pricing information"
        hybrid_alpha: 0.7
        inject_as: semanticChunks
        field_set: standard
        limit: 50  # Reduced default - context manager handles batching

model:
  api: chat
  configuration:
    type: pom-llm-proxy
    model: qwen3:8b
  parameters:
    temperature: 0.1
    response_format:
      type: json_object

processing_config:
  source_collection: Domain
  schema_id: Entity_facts
  record_key_fields:
    - domain
    - entity
    - fact
    - context_strategy

# Schema enforcement - output must match this structure
output_schema:
  type: object
  required: [facts]
  properties:
    facts:
      type: array
      items:
        type: object
        required: [entity, entity_type, fact, confidence]
        properties:
          entity:
            type: string
            description: Name of the entity this fact is about
          entity_type:
            type: string
            enum: [Product, Feature, Company, Person, Technology, Integration, Service, Pricing]
            description: Type classification of the entity
          fact:
            type: string
            description: Single atomic fact statement
          confidence:
            type: number
            minimum: 0.0
            maximum: 1.0
            description: Confidence score for this extraction
          source_url:
            type: string
            description: URL where this fact was found

---
# ðŸŽ¯ FACT EXTRACTOR

You are extracting facts from web content for the **{{ researcher_id | default('product') }}** researcher.

## ðŸ“‹ ENTITY TYPES

Extract entities of these types:
- **Product**: Products, platforms, solutions, offerings
- **Feature**: Capabilities, functionality, specifications
- **Company**: Organizations, subsidiaries, parent companies
- **Person**: Executives, founders, key people
- **Technology**: Tech stack, frameworks, APIs
- **Integration**: Connectors, partnerships, integrations
- **Service**: Services offered
- **Pricing**: Pricing information, tiers, costs

## ðŸ“Š SOURCE CONTENT

{% set domain_value = record.properties.domain if (record.properties is defined and record.properties.domain is defined) else (record.domain if record.domain is defined else 'unknown') %}
**Domain**: {{ domain_value }}
{% set chunks = semanticChunks if (semanticChunks is defined and semanticChunks | length > 0) else (record.semanticChunks if record.semanticChunks is defined else []) %}
**Chunks**: {{ chunks | length }}

{% if chunks and chunks | length > 0 %}
{% for chunk in chunks %}
{% set props = chunk.properties if (chunk.properties is defined) else chunk %}
---
**[{{ loop.index }}] {{ props.url | default('unknown') }}**
{{ props.content | default('') }}
{% endfor %}
{% else %}
**NO CONTENT AVAILABLE** - Return empty facts array.
{% endif %}

## ðŸŽ¯ EXTRACTION RULES

1. **ONE FACT PER ITEM**: Each fact must be atomic and standalone
2. **LITERAL ONLY**: Only extract facts directly stated in the text
3. **NO HALLUCINATION**: Never invent or infer information
4. **ENTITY REQUIRED**: Every fact must have an entity it describes
5. **CONFIDENCE**: Rate 0.0-1.0 based on how clearly stated the fact is

## ðŸ“¤ OUTPUT FORMAT

Output a JSON object with a "facts" array. Each fact object must have:
- `entity`: Name of the entity (e.g., "Yoco Khumo")
- `entity_type`: One of: Product, Feature, Company, Person, Technology, Integration, Service, Pricing
- `fact`: Single atomic fact statement
- `confidence`: Number 0.0-1.0
- `source_url`: URL where found (optional)

Example:
```json
{
  "facts": [
    {
      "entity": "Yoco Khumo",
      "entity_type": "Product",
      "fact": "Yoco Khumo is a standalone card machine with built-in 4G",
      "confidence": 0.95,
      "source_url": "https://yoco.com/products"
    },
    {
      "entity": "Yoco Khumo",
      "entity_type": "Pricing",
      "fact": "Yoco Khumo costs R699 once-off plus R49 monthly",
      "confidence": 0.90,
      "source_url": "https://yoco.com/pricing"
    }
  ]
}
```

{% if not chunks or chunks | length == 0 %}
Return: {"facts": []}
{% endif %}

Output valid JSON now:
