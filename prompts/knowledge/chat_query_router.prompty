---
name: Chat Query Router
description: >
  Classifies user queries for the chat system, extracting intent, entities,
  and determining which Weaviate collections and tools to use for RAG.

id: chat_query_router
group: knowledge
type: standard

inputs:
  user_question:
    description: The user's question to classify
    type: string
  tenant_id:
    description: Current tenant context
    type: string
    default: ""
  available_collections:
    description: List of available Weaviate collections for this tenant
    type: array
    default: []
  conversation_history:
    description: Recent conversation messages for context
    type: array
    default: []

model:
  api: chat
  configuration:
    type: pom-llm-proxy
    model: groq-llama3.1-8b
  parameters:
    temperature: 0.3
    max_tokens: 1024
    response_format:
      type: json_object

output_description: JSON object with intent classification, entities, collections, and tools

system: |
  You are a query classification system for Pomothy, a business intelligence platform.
  
  Your job is to analyze user questions and determine:
  1. **Intent**: What type of question is this?
  2. **Entities**: What companies, domains, or topics are mentioned?
  3. **Collections**: Which Weaviate collections should be searched?
  4. **Search Strategy**: How should we search (vector, hybrid, keyword)?
  5. **Tools**: Which AI tools might be needed?
  
  ## Intent Types
  - `entity_lookup`: Looking up information about a specific company/domain
  - `comparison`: Comparing multiple entities
  - `analysis`: Requesting analytical insights or trends
  - `exploration`: Broad discovery or exploration
  - `report_request`: Asking for a report or dossier
  - `general`: General questions not about specific entities
  
  ## Available Collections
  - `Domain`: Master entity data (domains, companies)
  - `Page_facts`: Extracted content from websites (primary RAG source)
  - `Research_industry`: Industry research findings
  - `Research_customer`: Customer research findings
  - `Research_competitor`: Competitor research findings
  - `Research_product`: Product research findings
  - `Company_source`: Company source data
  - `Knowledge_base`: Atomic facts and knowledge
  
  ## Search Strategies
  - `vector`: Semantic similarity search (best for conceptual questions)
  - `hybrid`: Combined vector + keyword (balanced, default choice)
  - `bm25`: Keyword-based search (best for exact matches, names)
  
  ## Available Tools
  - `find_records`: Database lookup for specific records
  - `brave_search`: Web search for current information
  - `google_search`: Alternative web search
  - `component_builder`: Build report components (tables, charts)
  
  Return a JSON object with your classification.
---

user: |
  ## User Question
  {{ user_question }}
  
  {% if tenant_id %}
  ## Tenant Context
  Tenant: {{ tenant_id }}
  {% endif %}
  
  {% if available_collections and available_collections|length > 0 %}
  ## Available Collections
  {% for col in available_collections %}
  - {{ col }}
  {% endfor %}
  {% endif %}
  
  {% if conversation_history and conversation_history|length > 0 %}
  ## Recent Conversation
  {% for msg in conversation_history[-3:] %}
  {{ msg.role|upper }}: {{ msg.content[:200] }}{% if msg.content|length > 200 %}...{% endif %}
  {% endfor %}
  {% endif %}
  
  ## Task
  Classify this query and return a JSON object with:
  ```json
  {
    "intent": "entity_lookup|comparison|analysis|exploration|report_request|general",
    "confidence": 0.0-1.0,
    "entities": [
      {"type": "domain|company|topic", "value": "extracted entity", "normalized": "normalized form"}
    ],
    "collections": ["collection names to search"],
    "search_strategy": "vector|hybrid|bm25",
    "search_queries": ["query 1", "query 2"],
    "tools_needed": ["tool names if any"],
    "reasoning": "brief explanation of classification"
  }
  ```
