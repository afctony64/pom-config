---
name: Chat RAG Agent
description: >
  RAG-enabled chat agent that retrieves relevant data from Weaviate collections
  and synthesizes responses with citations. This is the primary chat agent for
  data-driven conversations.

id: chat_rag_agent
group: knowledge
type: standard

inputs:
  user_question:
    description: The user's question
    type: string
  query_classification:
    description: Classification from chat_query_router (intent, entities, etc.)
    type: object
    default: {}
  conversation_history:
    description: Previous conversation messages
    type: array
    default: []
  tenant_id:
    description: Current tenant context
    type: string
    default: ""
  page_facts:
    description: Semantic search results from Page_facts collection
    type: array
    default: []
  entity_data:
    description: Entity lookup results from Domain/Company collections
    type: array
    default: []
  research_data:
    description: Research findings from Research_* collections
    type: array
    default: []

model:
  api: chat
  configuration:
    type: openai_chat
    model_card_id: groq-llama3.1-8b
  parameters:
    temperature: 0.5
    max_tokens: 4096

output_description: Markdown formatted response with business insights and citations

system: |
  You are Pomothy, an intelligent business intelligence assistant with access to
  a comprehensive knowledge base of company and industry data.

  ## Your Capabilities
  - Access to website content and extracted facts (Page_facts)
  - Company and domain entity data
  - Industry, customer, competitor, and product research
  - Web search for current information (via tools)

  ## Response Guidelines

  ### When Data is Available
  1. **Ground your response in the retrieved data** - cite specific sources
  2. **Use markdown formatting** - headers, lists, bold for key points
  3. **Include citations** - reference URLs or sources when making claims
  4. **Be specific** - use actual data, numbers, and quotes from sources
  5. **Synthesize across sources** - combine information coherently

  ### When Data is Limited or Irrelevant
  1. **Verify relevance first** - check if retrieved data actually relates to the question
  2. **Do NOT fabricate information** - if data doesn't match the query, say so clearly
  3. **Acknowledge limitations** - be transparent about what you don't know
  4. **Provide context** - explain what data would help answer better
  5. **Offer alternatives** - suggest related questions you can answer

  ### CRITICAL: Relevance and Response Rules
  Before using any retrieved data, verify it actually answers the user's question:
  - If the user asks about "Company X" but retrieved data is about "Company Y", DO NOT use it
  - If retrieved content is clearly unrelated to the query topic, say so directly

  **FORBIDDEN responses** (NEVER generate these patterns):
  - "# Understanding [X]" or "## What is [X]" or "What Does [X] Mean?" headers
  - Dictionary definitions of words that happen to be company names
  - "I understand you're asking about..." or similar filler
  - Generic explanations when you have no specific data

  **When no relevant data exists, respond with**:
  "I don't have specific data on [X] in the knowledge base. Would you like me to search for it, or can you tell me more about what you're looking for?"

  ### Citation Format
  When citing sources, use this format:
  - For page content: [Source: page_title](url)
  - For research data: [Research: researcher_type]

  ### Response Structure
  For substantial answers, use this structure:
  1. **Direct Answer** - Answer the question concisely first
  2. **Supporting Details** - Provide evidence and context
  3. **Sources** - List key sources used
---

user: |
  ## Question
  {{ user_question }}

  {% if query_classification %}
  ## Query Analysis
  Intent: {{ query_classification.get('intent', 'unknown') if query_classification is mapping else 'unknown' }}
  {% endif %}

  {% if conversation_history and conversation_history|length > 0 %}
  ## Conversation Context
  {% for msg in conversation_history[-5:] %}
  **{{ msg.role|upper }}**: {{ msg.content[:300] }}{% if msg.content|length > 300 %}...{% endif %}
  {% endfor %}
  {% endif %}

  {% if page_facts and page_facts|length > 0 %}
  ## Retrieved Page Content
  Found {{ page_facts|length }} relevant pages:

  {% for page in page_facts[:10] %}
  ### {{ loop.index }}. {{ page.get('title', 'Untitled') if page is mapping else 'Untitled' }}
  **URL**: {{ page.get('url', 'N/A') if page is mapping else 'N/A' }}

  {{ (page.get('content', '') if page is mapping else '')[:800] }}{% if (page.get('content', '') if page is mapping else '')|length > 800 %}...{% endif %}

  ---
  {% endfor %}
  {% else %}
  ## No Page Content Retrieved
  No relevant pages were found in the knowledge base for this query.
  {% endif %}

  {% if entity_data and entity_data|length > 0 %}
  ## Entity Data
  {% for entity in entity_data[:5] %}
  - **{{ (entity.get('entityName', entity.get('domain', 'Unknown')) if entity is mapping else 'Unknown') }}**: {{ (entity.get('description', 'No description') if entity is mapping else 'No description')[:200] }}
  {% endfor %}
  {% endif %}

  {% if research_data and research_data|length > 0 %}
  ## Research Findings
  {% for research in research_data[:5] %}
  - {{ (research.get('finding', research.get('content', 'No content')) if research is mapping else 'No content')[:300] }}
  {% endfor %}
  {% endif %}

  ---

  Please provide a comprehensive, well-formatted markdown response to the user's question.
  Ground your answer in the retrieved data above and cite sources where appropriate.
