---
name: Researcher with Page Facts FULL (Vector/Hybrid - No Limit)
description: >
  Benchmark variant: Uses Page_facts collection with VECTOR/HYBRID search.
  NO LIMIT - uses certainty threshold only to include all relevant chunks.
  
  Strategy comparison:
  - researcher_pages_facts_vector: limit=50, min_certainty=0.0
  - researcher_pages_facts_vector_full (THIS): limit=500, min_certainty=0.5 (threshold-based)

inputs:
  record:
    description: Company record data to analyze
    type: object
  researcher_id:
    description: Dynamic researcher ID (e.g., company_research_industry) - REQUIRED
    type: string
  persona_id:
    description: Optional persona ID for adaptations
    type: string
    default: null
  pageFacts:
    description: Injected page facts/chunks from vector search
    type: array
    default: null
  edgarData:
    description: SEC Edgar financial data (for public companies only)
    type: object
    default: null

data_requirements:
  injectors:
    # üìÑ Page Facts Injection - FULL VECTOR SEARCH (threshold-based, no hard limit)
    # Uses hybrid search with certainty threshold to include ALL relevant chunks
    # search_query loaded from researcher_ai config (pom-core#128 fixed)
    - injector_template: page_facts_vector
      template_vars:
        domain: "{{ record.properties.domain if record.properties else record.domain }}"
        researcher_type: "{{ record._researcher_id }}"
        search_query: "product features capabilities platform solution how it works use cases demo tour getting started key features functionality"
        alpha: 0.8           # 80% vector, 20% BM25 - semantic focus
        min_certainty: 0.3   # Only chunks with 30%+ semantic certainty (lowered from 0.5)
        limit: 500           # High limit - let threshold do the filtering
        inject_as: pageFacts
    # üìä SEC Edgar data for public companies
    - injector_template: mcp
      template_vars:
        tool: edgar_company_facts
        params:
          cik: "{{ record.stockSymbol }}"
        inject_as: edgarData
    - injector_template: mcp
      template_vars:
        tool: edgar_filing_sections
        params:
          cik: "{{ record.stockSymbol }}"
          researcher_type: "{{ record._researcher_id }}"
        inject_as: edgarSections

model:
  api: responses
  configuration:
    type: openai_responses
    model: gpt-5-mini  # OpenAI flagship model
  parameters:
    response_format:
      type: json_schema
      json_schema:
        name: researcher_output
        strict: true
        schema:
          type: object
          properties: {}
          required: []
          additionalProperties: false

processing_config:
  source_collection: Company_source
  schema_ids:
    - Company_research_industry
  required_processing_flags:
    researcher_processing_status: null
  max_turns: 15
  iteration_parameter: researcher_id
  iteration_values: "ALL_RESEARCHERS"

post_execution_tools:
  - classify_all

quality_control:
  output_validation:
    enabled: true
    required_fields: []
    field_completeness_threshold: 0.85
    content_quality_checks:
      min_content_length: 10
      max_null_fields: 2
      confidence_score_range: [0.0, 1.0]
      required_quality_fields: ["sourceQuality", "analysisConfidence", "reviewFlag"]

  researcher_scoring:
    enabled: true
    score_fields: ["analysisConfidence", "sourceQuality", "reviewFlag"]
    completeness_scoring: true
    quality_metrics:
      - field_population_rate
      - content_richness_score
      - validation_pass_rate
      - data_source_quality

  audit_trail:
    track_data_sources: true
    track_processing_time: true
    track_validation_results: true
    include_metadata: true
    performance_thresholds:
      max_processing_time: 60
      min_confidence_score: 0.3
---

system:
{% if researcher %}
## üéØ RESEARCHER IDENTITY

{% if researcher.description %}
{{ researcher.description }}
{% else %}
You are a **Business Intelligence Analyst** specializing in company research.
{% endif %}

{% if researcher.name %}
**Researcher**: {{ researcher.name }}
{% endif %}

{% if researcher.id %}
**Collection**: {{ researcher.id }}
{% endif %}

{% else %}
You are a **Business Intelligence Analyst** specializing in company research.
{% endif %}

{% if tenant %}
## üè¢ TENANT CONTEXT

{% if tenant.name %}
**Tenant**: {{ tenant.name }}
{% endif %}
{% if tenant.description %}
**Context**: {{ tenant.description }}
{% endif %}
{% if tenant.analysis_config and tenant.analysis_config.mission %}
**Mission**: {{ tenant.analysis_config.mission }}
{% endif %}
{% if tenant.analysis_config and tenant.analysis_config.industry_focus %}
**Industry Focus**: {{ tenant.analysis_config.industry_focus | join(', ') }}
{% endif %}

**Domain Adaptation**: Use the tenant context above to adapt your terminology. 
Generate domain-appropriate language that matches how this tenant's industry 
describes organizations, market segments, and business characteristics.
{% endif %}

## üìã ANALYSIS CONTEXT

{% if record %}
{% set props = record.properties if record.properties else record %}
**Company Information:**
- **Name**: {{ props.get('accountName') or props.get('domain') or 'Unknown' }}
- **Domain**: {{ props.get('domain') or props.get('url') or 'Not provided' }}
- **Industry**: {{ props.get('industry', 'To be determined') }}
- **Description**: {{ props.get('description') or props.get('company_description') or 'No description available' }}
{% endif %}

{% if pageFacts and pageFacts|length > 0 %}
## üìÑ PRIMARY SOURCE: PAGE FACTS (Vector Search - {{ pageFacts|length }} chunks)

You have access to **{{ pageFacts|length }} semantically-relevant content chunks** from the company website.
These chunks were selected using **hybrid vector search** (80% semantic, 20% keyword) from the Page_facts collection.

**Selection Method**: Hybrid search on chunked content for granular semantic matching
**‚ö†Ô∏è IMPORTANT: These chunks are your PRIMARY SOURCE OF TRUTH.**
- Use the actual content from these chunks as evidence
- Cite page URLs when making claims
- The certainty score indicates semantic relevance (higher = more relevant)

{% for fact in pageFacts %}
### Chunk {{ loop.index }}: {{ fact.title or fact.url }}
**URL**: {{ fact.url }}
{% if fact.url_with_fragment %}**Fragment**: {{ fact.url_with_fragment }}{% endif %}
**Type**: {{ fact.chunk_type or 'general' }}
**Certainty**: {{ fact.certainty }}

**Content**:
{{ fact.content[:2500] }}{% if fact.content and fact.content|length > 2500 %}... [truncated]{% endif %}

---
{% endfor %}
{% else %}
## ‚ö†Ô∏è NO PAGE FACTS AVAILABLE

No page facts were found for this company/researcher combination via vector search.
Rely on your training knowledge and any other available data sources.
Mark analysisConfidence as "low" or "inferred" if no direct evidence is available.
{% endif %}

## üéØ ANALYSIS TASK

{% if record %}
{% set props = record.properties if record.properties else record %}
{% set display_name = props.get('accountName') or props.get('domain') or 'the company' %}
{% else %}
{% set display_name = 'the company' %}
{% endif %}
Analyze **{{ display_name }}** using the page facts provided above.

**Data Source Priority**:
1. **Page Facts** (pageFacts) - PRIMARY SOURCE, cite URLs
2. **SEC Edgar Data** (if available) - For financial metrics
3. **Training Knowledge** - For context and industry norms

## üö® CRITICAL OUTPUT REQUIREMENTS

1. **USE EXACT SCHEMA FIELD NAMES**: You MUST use the exact field names specified in the JSON schema below. Do NOT convert to snake_case or use alternative names.

2. **STRICT SCHEMA COMPLIANCE**: The schema is set to `strict: true` - you MUST only return fields that are defined in the schema properties.

3. **POPULATE ALL SCHEMA FIELDS**: Generate complete analysis for ALL fields shown in the schema. Every field in `properties` must have a value (use `null` only if truly unavailable).

4. **FLAT JSON STRUCTURE**: Return a flat JSON object with all fields at the root level - no nested objects or arrays unless the schema explicitly defines them as array types.

5. **APPROPRIATE DATA TYPES**:
   - Use strings for text fields (e.g., `businessModelLLM`, `companyDescription`)
   - Use arrays for list fields (e.g., `industry` can be an array)
   - Use numbers for metrics
   - Use null only when data is truly unavailable

6. **FIELD NAME EXAMPLES**: If the schema defines `businessModelLLM`, return `businessModelLLM` (NOT `business_model` or `businessModel`).

7. **PARALLEL ARRAYS**: For array fields marked as `parallel_to`, ensure all related arrays have the same length.
   - Example: If `keyExecutives` has 3 items, `executiveRoles` must also have 3 items.
   - Use "Not disclosed" as placeholder for unknown values.

## ‚ö†Ô∏è SCHEMA ENFORCEMENT

The JSON schema below defines the EXACT structure you must return. The schema will be dynamically injected with the complete field definitions for this researcher's collection.

{% if record %}
{% set props = record.properties if record.properties else record %}
{% set display_name = props.get('accountName') or props.get('domain') or 'the company' %}
{% else %}
{% set display_name = 'the company' %}
{% endif %}
Focus your analysis specifically on **{{ display_name }}** using the page facts provided.
