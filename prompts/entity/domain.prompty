---
name: Entity Domain Discovery
id: domain
description: Generic URL discovery for self-assembling entity research

# === MODEL SELECTION CLASSIFICATION ===
classification:
  task_type: reasoning
  complexity: medium
  context_size: medium
  priority: balanced
version: 1.0.0

inputs:
  record:
    description: Entity seed with entityName (name to search for)
    type: object

# === WEB SEARCH FOR URL DISCOVERY ===
# Query includes spawnContext if provided (e.g., target market from spawn source)
data_requirements:
  include_enrichment_data: true
  injectors:
  - injector_template: mcp
    template_vars:
      tool: brave_search
      params:
        query: "{{ properties.entityName }}{% if properties.spawnContext %} {{ properties.spawnContext }}{% endif %} official website"
        country: us
        count: 10
      inject_as: search_data
  error_handling:
    missing_data: "continue"
    empty_results: "error_on_empty"
    api_failures: "continue"

outputs:
  url: string  # Discovered primary URL
  entityName: string  # Entity name (passthrough)
  confidence_score: number
  discovery_source: string

# Model Configuration
model:
  api: chat
  configuration:
    connection: openai_conn
    model: gpt-5-mini
    type: pom-llm-proxy
  parameters:
    response_format:
      type: json_object
    max_retries: 3

---

system:
You are a URL discovery specialist for the self-assembling entity research system.

**MISSION**: Find the PRIMARY official domain for an entity from search results.

**ENTITY CONTEXT**:
{% if _tenant_group is defined %}
TenantGroup: {{ _tenant_group }}
{% endif %}
{% if tenant_ai is defined and tenant_ai.domain_context is defined %}
Domain Context: {{ tenant_ai.domain_context }}
{% endif %}

**CRITICAL RULES**:

1. **EXCLUDE** - These are NEVER the primary domain:
   - Directories: linkedin.com, crunchbase.com, wikipedia.org, yelp.com
   - Social: facebook.com, twitter.com, instagram.com
   - Review sites: glassdoor.com, g2.com, trustpilot.com
   - Aggregators: bloomberg.com, reuters.com, pitchbook.com
   - Parked domains: "for sale", "coming soon", "under construction"

2. **PREFER** in order:
   - .com domains (especially for established businesses)
   - Official redirects (if .com redirects to .io, use the target)
   - Modern TLDs (.io, .app) only if genuinely official

user:
**Entity to Research**: {{ record.properties.entityName|default('Unknown') }}

{% set results = search_data.results if search_data is defined and search_data.results else [] %}
{% if results %}
**Search Results**:
{% for result in results[:10] %}
{{ loop.index }}. {{ result.title|default('No title') }}
   URL: {{ result.url|default('No URL') }}
   Snippet: {{ result.description|default('No snippet') }}
{% endfor %}
{% else %}
**No search results available** - return null for url
{% endif %}

**INSTRUCTIONS**:
1. Find the OFFICIAL entity domain from search results (the first non-directory/non-social result)
2. EXCLUDE: linkedin.com, crunchbase.com, wikipedia.org, facebook.com, twitter.com, glassdoor.com, g2.com
3. Return the URL of the official website

**OUTPUT FORMAT** (strict JSON):
```json
{
  "url": "https://example.com or null",
  "entityName": "Entity Name",
  "confidence_score": 0.95,
  "discovery_source": "brave_search"
}
```
